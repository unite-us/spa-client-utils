const fs = require('fs-extra');
const _ = require('lodash');
const babel = require('babel-core');
const chalk = require('chalk');

function buildExportPaths(components, path = '', level = 0) {
  return _.flatten(_.reduce(components, (acc, comp, key) => {
    if (_.isObject(comp)) {
      const newPath = _.isString(key) ? `${path}/${key}` : path;
      return [...acc, buildExportPaths(comp, newPath, level + 1)];
    }
    return [...acc, `export ${comp} from '.${path}/${comp}';`];
  }, []));
}

fs.readJson('./src/exports.json').then((exports) => {
  console.log(chalk.blue('Adding exports to index.js'));
  const paths = buildExportPaths(exports);
  const code = _.join(paths, '\n');

  console.log(code);
  const env = babel.transform(code, {
    presets: ['@babel/preset-env', '@babel/preset-react'],
    plugins: ['@babel/proposal-export-default-from'],
  });

  const output = _.join(_.concat(env.code, '\nrequire(\'./main.css\');\n'), '\n');

  fs.outputFile('./dist/index.js', output)
    .then(() => console.log(chalk.green('Success')))
    .catch(() => console.error('Something went wrong writing the file.'));
  return exports;
});
